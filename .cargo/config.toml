[alias]
xdbg = "run --bin xdbg --"
xli = "run --bin xmtp_cli --"
update-schema = "run --bin update-schema --features update-schema"
bindgen = "run --bin ffi-uniffi-bindgen --features uniffi/cli"
bindgen-swift = "run --bin ffi-uniffi-bindgen-swift --features uniffi/cli"

# see: https://github.com/rust-lang/cargo/issues/5376#issuecomment-2163350032
# We use this instead of [build] because target.*.rustflags are merged by default
[target."cfg(all())"]
rustflags = ["--cfg", "tracing_unstable"]

[target.wasm32-unknown-unknown]
runner = 'wasm-bindgen-test-runner'
rustflags = [
  '--cfg',
  'getrandom_backend="wasm_js"',
  '-C',
  'target-feature=+bulk-memory,+mutable-globals',
]

# Musl targets default to crt-static, but crt_static_allows_dylibs is false
# in the target spec. Disabling crt-static allows cdylib (.node shared libraries)
# to be built. The resulting .node files dynamically link musl libc, which is
# correct for musl environments (Alpine Linux, etc.).
# These merge with the cfg(all()) rustflags above.
[target.x86_64-unknown-linux-musl]
rustflags = ["-C", "target-feature=-crt-static"]

[target.aarch64-unknown-linux-musl]
rustflags = ["-C", "target-feature=-crt-static"]

[target.aarch64-linux-android]
rustflags = ["-Clink-arg=-Wl,-z,max-page-size=16384"]

[target.armv7-linux-androideabi]
rustflags = ["-Clink-arg=-Wl,-z,max-page-size=16384"]

[target.i686-linux-android]
rustflags = ["-Clink-arg=-Wl,-z,max-page-size=16384"]

[target.x86_64-linux-android]
rustflags = ["-Clink-arg=-Wl,-z,max-page-size=16384"]

# Codegen units can also be set if needed
[profile.dev]
# build scripts don't need extra assertions
build-override = { opt-level = 3, debug = false, debug-assertions = false, overflow-checks = false, incremental = false }
# Build all non-local dependencies in release mode
package."*" = { opt-level = 3, debug = false, debug-assertions = false, overflow-checks = false, incremental = false }
# It uses debug_assertions internally to decide whether to choose where to use `max_level_*` or `release_max_level_*`
package.tracing = { opt-level = 3, debug = false, debug-assertions = true, overflow-checks = false, incremental = false }

[profile.test]
# build scripts don't need extra assertions
build-override = { opt-level = 3, debug = false, debug-assertions = false, overflow-checks = false, incremental = false }
# Build all non-local dependencies in release mode
package."*" = { opt-level = 3, debug = false, debug-assertions = false, overflow-checks = false, incremental = false }
# It uses debug_assertions internally to decide whether to choose where to use `max_level_*` or `release_max_level_*`
package.tracing = { opt-level = 3, debug = false, debug-assertions = true, overflow-checks = false, incremental = false }
