name: Ignored Tests Tracker
on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
    # Allow manual trigger for testing

env:
  CARGO_TERM_COLOR: never
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_TEST_DEBUG: 0

jobs:
  test-ignored-native:
    name: Native Ignored Tests (${{ matrix.features }})
    runs-on: warp-ubuntu-latest-x64-16x
    strategy:
      fail-fast: false
      matrix:
        include:
          - features: "default"
            feature_flag: ""
          - features: "d14n"
            feature_flag: "--features d14n"
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache
        uses: WarpBuilds/rust-cache@v2
        with:
          workspaces: |
            .

      - name: Run ignored tests
        id: run-tests
        continue-on-error: true
        run: |
          set +e
          cargo test --workspace --exclude bindings_wasm ${{ matrix.feature_flag }} -- --ignored 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.features }}-results
          path: test-output.txt
          retention-days: 1

  test-ignored-wasm:
    name: WASM Ignored Tests (${{ matrix.features }})
    runs-on: warp-ubuntu-latest-x64-8x
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - features: "default"
            feature_flag: ""
          - features: "d14n"
            feature_flag: "--features d14n"
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache
        uses: WarpBuilds/rust-cache@v2
        with:
          workspaces: |
            .
      - uses: DeterminateSystems/nix-installer-action@main
        with:
          determinate: true
      - uses: DeterminateSystems/flakehub-cache-action@main
      - uses: cachix/cachix-action@v16
        with:
          name: xmtp
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Run ignored tests
        id: run-tests
        continue-on-error: true
        run: |
          set +e
          # Use --workspace with exclusions to automatically pick up new WASM-compatible packages
          # Exclusions based on nix/package/wasm.nix - packages that don't support WASM target
          nix develop .#wasm --command \
            cargo test --locked --release ${{ matrix.feature_flag }} \
            --workspace \
            --exclude xmtpv3 \
            --exclude bindings_node \
            --exclude xmtp_cli \
            --exclude xdbg \
            --exclude mls_validation_service \
            --exclude xmtp_api_grpc \
            --exclude xmtp-db-tools \
            -- --ignored 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: wasm-${{ matrix.features }}-results
          path: test-output.txt
          retention-days: 1

  update-issue:
    name: Update Tracking Issue
    runs-on: ubuntu-latest
    needs: [test-ignored-native, test-ignored-wasm]
    if: always()
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Parse results and update issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          # Function to parse test output and extract results
          # Output format: passed|failed|test_results_markdown
          parse_test_output() {
            local file="$1"
            local passed=0
            local failed=0
            local test_results=""

            if [[ -f "$file" ]]; then
              # Extract test results - look for lines with "test ... ok" or "test ... FAILED"
              # Pattern matches: "test module::path::test_name ... ok" or "... FAILED"
              while IFS= read -r line; do
                if [[ "$line" =~ ^test[[:space:]]+(.+)[[:space:]]+\.\.\.[[:space:]]+(ok|FAILED) ]]; then
                  test_name="${BASH_REMATCH[1]}"
                  result="${BASH_REMATCH[2]}"
                  if [[ "$result" == "ok" ]]; then
                    ((passed++)) || true
                    test_results+="| \`${test_name}\` | :white_check_mark: ok |"$'\n'
                  else
                    ((failed++)) || true
                    test_results+="| \`${test_name}\` | :x: FAILED |"$'\n'
                  fi
                fi
              done < "$file"
            fi

            printf '%d|%d|%s' "$passed" "$failed" "$test_results"
          }

          # Parse each configuration's results
          native_default=$(parse_test_output "artifacts/native-default-results/test-output.txt")
          native_d14n=$(parse_test_output "artifacts/native-d14n-results/test-output.txt")
          wasm_default=$(parse_test_output "artifacts/wasm-default-results/test-output.txt")
          wasm_d14n=$(parse_test_output "artifacts/wasm-d14n-results/test-output.txt")

          # Extract counts using parameter expansion
          native_default_passed="${native_default%%|*}"
          native_default_rest="${native_default#*|}"
          native_default_failed="${native_default_rest%%|*}"
          native_default_tests="${native_default_rest#*|}"

          native_d14n_passed="${native_d14n%%|*}"
          native_d14n_rest="${native_d14n#*|}"
          native_d14n_failed="${native_d14n_rest%%|*}"
          native_d14n_tests="${native_d14n_rest#*|}"

          wasm_default_passed="${wasm_default%%|*}"
          wasm_default_rest="${wasm_default#*|}"
          wasm_default_failed="${wasm_default_rest%%|*}"
          wasm_default_tests="${wasm_default_rest#*|}"

          wasm_d14n_passed="${wasm_d14n%%|*}"
          wasm_d14n_rest="${wasm_d14n#*|}"
          wasm_d14n_failed="${wasm_d14n_rest%%|*}"
          wasm_d14n_tests="${wasm_d14n_rest#*|}"

          # Calculate totals
          native_default_total=$((native_default_passed + native_default_failed))
          native_d14n_total=$((native_d14n_passed + native_d14n_failed))
          wasm_default_total=$((wasm_default_passed + wasm_default_failed))
          wasm_d14n_total=$((wasm_d14n_passed + wasm_d14n_failed))

          # Get current timestamp
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Build issue body using a heredoc
          cat > issue-body.md << 'ISSUE_HEADER'
          # Ignored Tests Status Report

          This issue tracks the status of tests marked with `#[ignore]` in the codebase.
          These tests are typically skipped during normal CI runs but are monitored here.

ISSUE_HEADER

          cat >> issue-body.md << EOF
          **Last Updated:** ${timestamp}
          **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Summary

          | Target | Passed | Failed | Total |
          |--------|--------|--------|-------|
          | Native | ${native_default_passed} | ${native_default_failed} | ${native_default_total} |
          | Native + d14n | ${native_d14n_passed} | ${native_d14n_failed} | ${native_d14n_total} |
          | WASM | ${wasm_default_passed} | ${wasm_default_failed} | ${wasm_default_total} |
          | WASM + d14n | ${wasm_d14n_passed} | ${wasm_d14n_failed} | ${wasm_d14n_total} |

          ## Native

          <details>
          <summary>Test Results (${native_default_total} tests)</summary>

          | Test | Result |
          |------|--------|
          ${native_default_tests}
          </details>

          ## Native + d14n

          <details>
          <summary>Test Results (${native_d14n_total} tests)</summary>

          | Test | Result |
          |------|--------|
          ${native_d14n_tests}
          </details>

          ## WASM

          <details>
          <summary>Test Results (${wasm_default_total} tests)</summary>

          | Test | Result |
          |------|--------|
          ${wasm_default_tests}
          </details>

          ## WASM + d14n

          <details>
          <summary>Test Results (${wasm_d14n_total} tests)</summary>

          | Test | Result |
          |------|--------|
          ${wasm_d14n_tests}
          </details>

          ---
          *This issue is automatically updated by the [Ignored Tests Tracker](.github/workflows/ignored-tests-tracker.yml) workflow.*
EOF

          # Find or create the tracking issue
          issue_number=$(gh issue list --label "ignored-tests-tracker" --state open --json number --jq '.[0].number // empty')

          if [[ -z "$issue_number" ]]; then
            # Create the issue if it doesn't exist
            gh issue create \
              --title "Ignored Tests Status Report" \
              --body-file issue-body.md \
              --label "ignored-tests-tracker"
            echo "Created new tracking issue"
          else
            # Update the existing issue
            gh issue edit "$issue_number" --body-file issue-body.md
            echo "Updated tracking issue #${issue_number}"
          fi
