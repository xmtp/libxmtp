name: Release Kotlin Bindings
on:
  workflow_dispatch:
jobs:
  build-linux:
    runs-on: warp-ubuntu-latest-x64-16x
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-linux-android
          - i686-linux-android
          - armv7-linux-androideabi
          - aarch64-linux-android
        include:
          - target: x86_64-linux-android
            output_target: x86_64
          - target: i686-linux-android
            output_target: x86
          - target: armv7-linux-androideabi
            output_target: armeabi-v7a
          - target: aarch64-linux-android
            output_target: arm64-v8a
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: ./.github/actions/setup-nix
        with:
          github-token: ${{ github.token }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Build jniLibs
        run: |
          nix develop --command \
            cargo ndk -o bindings/mobile/jniLibs --manifest-path ./bindings/mobile/Cargo.toml \
            -t ${{ matrix.target }} -- build --release
      - name: Prepare JNI libs
        run: |
          cp bindings/mobile/jniLibs/${{ matrix.output_target }}/libxmtpv3.so bindings/mobile/jniLibs/${{ matrix.output_target }}/libuniffi_xmtpv3.so
      - name: Upload binary
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.output_target }}
          path: bindings/mobile/jniLibs/${{ matrix.output_target }}/libuniffi_xmtpv3.so
          retention-days: 1
  package-kotlin:
    needs: [build-linux]
    runs-on: warp-ubuntu-latest-x64-16x
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: bindings/mobile/jniLibs
      - name: Build archive
        working-directory: bindings/mobile
        run: |
          zip -r LibXMTPKotlinFFI.zip jniLibs
      - name: Get short SHA
        id: slug
        run: echo "sha7=$(echo "${GITHUB_SHA}" | cut -c1-7)" >> "$GITHUB_OUTPUT"
      - name: Create release and upload asset
        uses: softprops/action-gh-release@v2
        with:
          files: ./bindings/mobile/LibXMTPKotlinFFI.zip
          tag_name: kotlin-bindings-${{ steps.slug.outputs.sha7 }}
          name: Kotlin-Bindings-${{ steps.slug.outputs.sha7 }}
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
