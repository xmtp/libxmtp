name: Build (and push/deploy) MLS Validation Service

on:
  push:
    branches: [main] # main: push SHA tag
  pull_request: # PRs: build only
  workflow_dispatch: # manual: full tags + deploy

env:
  IMAGE: ghcr.io/xmtp/mls-validation-service

jobs:
  build:
    name: Build (${{ matrix.arch }})
    runs-on: warp-ubuntu-latest-x64-16x
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: ./.github/actions/setup-nix
        with:
          github-token: ${{ github.token }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Build Docker image
        run: nix build .#validation-service-image-${{ matrix.arch }} -L
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-${{ matrix.arch }}
          path: result

  push:
    name: Push to GHCR
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name != 'pull_request' }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install toml-cli
        run: cargo install toml-cli

      - name: Get Crate Version
        id: version
        run: echo "version=$(toml get -r Cargo.toml workspace.package.version)" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download image artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: image-*

      - name: Determine SHA tag
        id: sha
        run: echo "tag=sha-$(echo ${{ github.sha }} | cut -c1-7)" >> "$GITHUB_OUTPUT"

      - name: Load and push arch-specific images
        run: |
          # Load amd64 image (tagged :main by Nix)
          docker load -i image-amd64/result
          docker tag ${{ env.IMAGE }}:main ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }}-amd64
          docker push ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }}-amd64

          # Load arm64 image (overwrites :main)
          docker load -i image-arm64/result
          docker tag ${{ env.IMAGE }}:main ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }}-arm64
          docker push ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }}-arm64

      - name: Create and push multi-arch manifest (SHA)
        run: |
          docker manifest create ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }} \
            ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }}-amd64 \
            ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }}-arm64
          docker manifest push ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }}

      - name: Push version tags (manual dispatch only)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          VERSION=${{ steps.version.outputs.version }}

          for TAG in "v${VERSION}" "${VERSION}" "latest"; do
            docker manifest create ${{ env.IMAGE }}:${TAG} \
              ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }}-amd64 \
              ${{ env.IMAGE }}:${{ steps.sha.outputs.tag }}-arm64
            docker manifest push ${{ env.IMAGE }}:${TAG}
          done

    outputs:
      digest: ${{ steps.sha.outputs.tag }}

  deploy:
    name: Deploy new MLS validation image to infra
    runs-on: ubuntu-latest
    needs: push
    if: ${{ github.event_name == 'workflow_dispatch' }}
    strategy:
      matrix:
        environment: [dev, production, testnet-staging, testnet-dev, testnet]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Deploy to ${{ matrix.environment }}
        uses: xmtp-labs/terraform-deployer@v1
        with:
          terraform-token: ${{ secrets.TERRAFORM_TOKEN }}
          terraform-org: xmtp
          terraform-workspace: ${{ matrix.environment }}
          variable-name: validation_service_image
          variable-value: "ghcr.io/xmtp/mls-validation-service:${{ needs.push.outputs.digest }}"
          variable-value-required-prefix: "ghcr.io/xmtp/mls-validation-service:"
