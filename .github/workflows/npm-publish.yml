name: NPM Publish

on:
  workflow_call:
    inputs:
      package-dir:
        description: 'Path to the npm package directory'
        required: true
        type: string
      tag-prefix:
        description: 'Prefix for git tags (e.g., node-bindings, wasm-bindings)'
        required: true
        type: string
      artifact-pattern:
        description: 'Pattern for downloading build artifacts (optional)'
        required: false
        type: string
      artifact-path:
        description: 'Path to download artifacts to (required if artifact-pattern is set)'
        required: false
        type: string

jobs:
  publish:
    permissions:
      id-token: write
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download build artifacts
        if: ${{ inputs.artifact-pattern != '' }}
        uses: actions/download-artifact@v7
        with:
          pattern: ${{ inputs.artifact-pattern }}
          merge-multiple: true
          path: ${{ inputs.artifact-path }}

      - name: Setup node
        uses: ./.github/actions/setup-node
        with:
          cache-dependency-path: "${{ inputs.package-dir }}/yarn.lock"

      - name: Install dependencies
        working-directory: ${{ inputs.package-dir }}
        run: yarn

      - name: Update version for dev releases
        working-directory: ${{ inputs.package-dir }}
        run: |
          # Read the current version from package.json
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          # Check if this is a dev version
          if [[ "$PACKAGE_VERSION" == *"dev"* ]]; then
            GIT_HASH=$(git log -1 --pretty=format:"%h")

            # Create a new version string with the git hash
            NEW_VERSION="${PACKAGE_VERSION}.${GIT_HASH}"

            # Update package.json with the new version
            npm version "$NEW_VERSION" --no-git-tag-version

            echo "Updated version to $NEW_VERSION for publishing"
          else
            echo "Not a dev version, keeping original version: $PACKAGE_VERSION"
          fi

      - name: Determine NPM tag
        id: npm-tag
        working-directory: ${{ inputs.package-dir }}
        run: |
          # Read the current version from package.json
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          # Set the tag based on whether it's a dev version
          if [[ "$PACKAGE_VERSION" == *"dev"* ]]; then
            echo "tag=prerelease" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Create Git Tag for Dev Releases
        if: contains(steps.npm-tag.outputs.tag, 'prerelease')
        run: |
          # Read the current version from package.json
          PACKAGE_VERSION=$(node -p "require('./${{ inputs.package-dir }}/package.json').version")

          # Create and push the tag
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a "${{ inputs.tag-prefix }}-${PACKAGE_VERSION}" -m "${{ inputs.tag-prefix }} version ${PACKAGE_VERSION}"
          git push origin "${{ inputs.tag-prefix }}-${PACKAGE_VERSION}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Publish to NPM
        uses: JS-DevTools/npm-publish@v4
        with:
          package: ${{ inputs.package-dir }}
          tag: ${{ steps.npm-tag.outputs.tag }}
          dry-run: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
