name: Test Workspace
on:
  workflow_call:
env:
  NIX_DEVSHELL: rust
  CARGO_TEST_CMD: "cargo llvm-cov nextest --no-fail-fast --no-report"
jobs:
  test:
    name: Test (Rust Workspace)
    runs-on: warp-ubuntu-latest-x64-16x
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - uses: ./.github/actions/setup-nix
        with:
          github-token: ${{ github.token }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          sccache: "true"
      - uses: taiki-e/install-action@just
      - name: Start backend
        run: just backend up
      - name: Dump docker logs on failure
        if: failure()
        uses: jwalton/gh-docker-logs@v2
      - name: Run tests (v3 + d14n with coverage)
        run: just test
      - name: Generate coverage report
        run: nix develop .#rust --command cargo llvm-cov report --output-path lcov.info --lcov
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
