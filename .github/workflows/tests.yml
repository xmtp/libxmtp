name: iOS Integration Tests

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GPR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GPR_USER: ${{ secrets.GITHUB_ACTOR }}

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    outputs:
      node_url: ${{ steps.deploy.outputs.node_url }}
      history_url: ${{ steps.deploy.outputs.history_url }}
      app_name: ${{ steps.deploy.outputs.app_name }}
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy multi-container machine
        id: deploy
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          APP_NAME="xmtp-ios-test-${{ github.run_id }}-${{ github.run_attempt }}"
          ./dev/fly/deploy "$APP_NAME"
          echo "app_name=$APP_NAME"
          echo "node_url=https://${APP_NAME}.fly.dev"
          echo "history_url=https://${APP_NAME}.fly.dev:5558"

      - name: Wait for services to be ready
        run: |
          NODE_URL="${{ steps.deploy.outputs.node_url }}"
          # Extract hostname from URL
          NODE_HOST="${NODE_URL#https://}"
          echo "Waiting for gRPC service at ${NODE_HOST}:443..."

          for i in {1..60}; do
            # Use openssl to verify TLS connection to the gRPC service
            if echo | openssl s_client -connect "${NODE_HOST}:443" -servername "${NODE_HOST}" 2>/dev/null | grep -q "CONNECTED"; then
              echo "Services are ready! (TLS connection successful)"
              exit 0
            fi

            echo "Waiting... (attempt $i/60)"
            sleep 5
          done

          echo "Services failed to become ready after 5 minutes"
          echo "Final diagnostic:"
          echo | openssl s_client -connect "${NODE_HOST}:443" -servername "${NODE_HOST}" 2>&1 || true
          exit 1

  tests:
    runs-on: warp-macos-15-arm64-6x
    needs: deploy-backend
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.0"

      - name: Build everything
        run: swift build --build-tests -q

      - name: Run iOS tests
        env:
          XMTP_NODE_ADDRESS: ${{ needs.deploy-backend.outputs.node_url }}
          XMTP_HISTORY_SERVER_ADDRESS: ${{ needs.deploy-backend.outputs.history_url }}
        run: |
          echo "Node URL: $XMTP_NODE_ADDRESS"
          echo "History URL: $XMTP_HISTORY_SERVER_ADDRESS"
          ./script/run_tests.sh

  cleanup:
    runs-on: ubuntu-latest
    needs: [deploy-backend, tests]
    if: always()
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Stop machine (triggers auto-destroy via --rm)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          APP_NAME="${{ needs.deploy-backend.outputs.app_name }}"
          if [ -n "$APP_NAME" ]; then
            echo "Cleaning up app: $APP_NAME"
            # Stop all machines - this triggers the --rm auto-destroy
            flyctl machine stop --app "$APP_NAME" --select || true
            # Give it a moment to clean up
            sleep 5
            # Force destroy the app
            flyctl apps destroy "$APP_NAME" --yes || true
          fi
          echo "Cleanup complete (timeout provides fallback if this fails)"
