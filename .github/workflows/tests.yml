name: iOS Integration Tests

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GPR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GPR_USER: ${{ secrets.GITHUB_ACTOR }}

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    outputs:
      node_url: ${{ steps.deploy.outputs.node_url }}
      history_url: ${{ steps.deploy.outputs.history_url }}
      app_name: ${{ steps.deploy.outputs.app_name }}
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy multi-container machine
        id: deploy
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          # Generate unique app name for this run
          APP_NAME="xmtp-ios-test-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "Creating app: $APP_NAME"

          # Create the app explicitly (so we know the name)
          # Fail if creation fails for reasons other than "already exists"
          flyctl apps create "$APP_NAME" --org xmtp-labs || {
            flyctl apps show "$APP_NAME" >/dev/null 2>&1 || { echo "Failed to create app: $APP_NAME"; exit 1; }
          }

          # Allocate shared IPv4 for the app
          flyctl ips allocate-v4 --shared --app "$APP_NAME" || true

          # Deploy multi-container machine using native Fly feature
          flyctl machine run \
            --app "$APP_NAME" \
            --region sjc \
            --rm \
            --restart no \
            --machine-config ci/fly/machine-config.json

          echo "app_name=$APP_NAME" >> "$GITHUB_OUTPUT"
          echo "node_url=https://${APP_NAME}.fly.dev" >> "$GITHUB_OUTPUT"
          echo "history_url=https://${APP_NAME}.fly.dev:5558" >> "$GITHUB_OUTPUT"

      - name: Wait for services to be ready
        run: |
          NODE_URL="${{ steps.deploy.outputs.node_url }}"
          echo "Waiting for services at ${NODE_URL}..."

          for i in {1..60}; do
            # Get HTTP status code (no -f flag so we always get the code)
            http_code=$(curl -s --max-time 10 -o /dev/null -w '%{http_code}' "${NODE_URL}" 2>/dev/null || echo "000")

            echo "Attempt $i/60: HTTP $http_code"

            # 000 = connection failed or timeout
            # 5xx = Fly proxy error (502/503) or backend error - keep waiting
            # 2xx/3xx/4xx = backend service is responding (4xx is expected for non-gRPC requests)
            if [[ "$http_code" =~ ^[234][0-9][0-9]$ ]]; then
              echo "Services are ready!"
              exit 0
            fi

            sleep 5
          done

          echo "Services failed to become ready after 5 minutes"
          echo "Final diagnostic:"
          curl -v --max-time 10 "${NODE_URL}" 2>&1 || true
          exit 1

  tests:
    runs-on: warp-macos-15-arm64-6x
    needs: deploy-backend
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.0"

      - name: Build everything
        run: swift build --build-tests -q

      - name: Run iOS tests
        env:
          XMTP_NODE_ADDRESS: ${{ needs.deploy-backend.outputs.node_url }}
          XMTP_HISTORY_SERVER_ADDRESS: ${{ needs.deploy-backend.outputs.history_url }}
        run: |
          echo "Node URL: $XMTP_NODE_ADDRESS"
          echo "History URL: $XMTP_HISTORY_SERVER_ADDRESS"
          ./script/run_tests.sh

  cleanup:
    runs-on: ubuntu-latest
    needs: [deploy-backend, tests]
    if: always()
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Stop machine (triggers auto-destroy via --rm)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          APP_NAME="${{ needs.deploy-backend.outputs.app_name }}"
          if [ -n "$APP_NAME" ]; then
            echo "Cleaning up app: $APP_NAME"
            # Stop all machines - this triggers the --rm auto-destroy
            flyctl machine stop --app "$APP_NAME" --select || true
            # Give it a moment to clean up
            sleep 5
            # Force destroy the app
            flyctl apps destroy "$APP_NAME" --yes || true
          fi
          echo "Cleanup complete (timeout provides fallback if this fails)"
