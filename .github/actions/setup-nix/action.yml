name: "Setup Nix"
description: "Install Nix with Cachix caching for XMTP"
inputs:
  github-token:
    description: "GitHub token for Nix installation"
    required: true
  cachix-auth-token:
    description: "Cachix auth token for xmtp cache"
    required: false
  sccache:
    description: "Enable sccache with GitHub Actions cache backend"
    required: false
    default: "false"
runs:
  using: "composite"
  steps:
    - uses: cachix/install-nix-action@v31
      with:
        github_access_token: ${{ inputs.github-token }}
        extra_nix_config: |
          accept-flake-config = true
          extra-substituters = https://cache.garnix.io
          extra-trusted-public-keys = cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g=
    - uses: cachix/cachix-action@v16
      if: ${{ inputs.cachix-auth-token != '' }}
      with:
        name: xmtp
        authToken: ${{ inputs.cachix-auth-token }}
    - uses: cachix/cachix-action@v16
      if: ${{ inputs.cachix-auth-token == '' }}
      with:
        name: xmtp
    - name: Setup sccache
      if: ${{ inputs.sccache == 'true' }}
      uses: mozilla-actions/sccache-action@v0.0.9
    - name: Configure sccache env
      if: ${{ inputs.sccache == 'true' }}
      run: |
        echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
        echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
      shell: bash
