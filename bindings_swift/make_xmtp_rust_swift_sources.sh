#!/bin/bash

set -ex

# This script creates Sources/XMTPRust/* from files generated by `make framework`

# Need to copy any Swift files in ./include/Generated to ./Sources/XMTPRust/*
FILES=$(find ./Generated -name "*.swift")

# HACK HACK HACK
# Here's the ultra-hack, we need to inject "import XMTPRustSwift" into the top of the Swift files
# before copying them over so they'll get the headers we moved to "include/Generated".
#
# Moreover, we inject the following lines to allow RustStrings to be interpreted as NSErrors and automatically
# displayed in the debugger:
# https://github.com/chinedufn/swift-bridge/issues/150
#
# extension RustString: @unchecked Sendable {}
#
# extension RustString: LocalizedError {
#     public var errorDescription: String? {
#         return NSLocalizedString("XMTP Rust Error: \(self.as_str().toString())", comment: self.as_str().toString())
#     }
# }
add_xmtprustswift_import() {
    echo "Injecting 'import XMTPRustSwift' text as first line into $1"
    sed -i '' '1s/^/import XMTPRustSwift\n\n/' "$1"
}
add_foundation_import() {
    echo "Injecting 'import Foundation' text as first line into $1"
    sed -i '' '1s/^/import Foundation\n\n/' "$1"
}
add_nserror_helpers() {
    sed -i '' '1s/^/extension RustString: @unchecked Sendable {}\nextension RustString: LocalizedError {\n    public var errorDescription: String? {\n        return NSLocalizedString("XMTP Rust Error: \\(self.as_str().toString())", comment: self.as_str().toString())\n    }\n}\n\n/' "$1"
}

rm -rf ./Sources
mkdir -p ./Sources/XMTPRust
for f in $FILES
do
    echo "Copying $f"
    cp "$f" "./Sources/XMTPRust/"
    f="./Sources/XMTPRust/$(basename $f)"
    # If it's a xmtp_rust_swift.swift file, then do the injection
    if [[ $f == *"xmtp_rust_swift.swift" ]]; then
      add_nserror_helpers "$f"
      # Only the xmtp_rust_swift.swift file needs Foundation
      add_foundation_import "$f"
    fi
    # All files need "import XMTPRustSwift"
    add_xmtprustswift_import "$f"
done

