import {
    ScrollView,
    HorizontalBox,
    VerticalBox,
} from "std-widgets.slint";

import {
    UIContextEntry,
    InstallationLabel,
    FocusBanner,
    IntermediateLogsPanel,
} from "epoch-tab.slint";

// ─── Timeline Data Structures ───

export struct UITimelineEntry {
    unique-id: int,
    msg: string,
    icon: string,
    installation-id: string,
    installation-name: string,
    installation-color: color,
    epoch: int,
    timestamp: int,
    slot-index: int,
    line-number: int,
    problems: [string],
    context: [UIContextEntry],
    intermediate: string,
}

export struct UITimelineInstallationRow {
    installation-id: string,
    installation-name: string,
    installation-color: color,
    entries: [UITimelineEntry],
}

export struct UITimelineGroup {
    group-id: string,
    group-id-short: string,
    group-color: color,
    installation-rows: [UITimelineInstallationRow],
    total-entries: int,
    total-slots: int,
}

// ─── Constants ───

global TimelineConstants {
    out property <length> entry-card-width: 200px;
    out property <length> entry-card-min-height: 60px;
    out property <length> entry-card-gap: 8px;
    out property <length> label-column-width: 150px;
    out property <length> row-height: 100px;
    out property <length> row-vertical-padding: 8px;
}

// ─── Timeline Entry Card ───

component TimelineEntryCard inherits Rectangle {
    in property <UITimelineEntry> entry;
    in property <bool> group-focused;

    callback warning-clicked();
    callback entry-clicked(/* group-id */ string, /* installation-id */ string, /* unique-id */ int);

    in property <string> group-id;

    property <bool> show-problems: root.entry.problems.length > 0;

    width: TimelineConstants.entry-card-width;
    min-height: TimelineConstants.entry-card-min-height;
    background: #ffffff;
    border-width: root.show-problems ? 2px : 1px;
    border-color: root.show-problems ? #cc4444 : #d0d0d0;
    border-radius: 6px;

    drop-shadow-blur: root.show-problems ? 4px : 2px;
    drop-shadow-offset-y: root.show-problems ? 2px : 1px;
    drop-shadow-color: root.show-problems ? #cc444420 : #00000010;

    // Make the entire card clickable
    card-touch := TouchArea {
        mouse-cursor: pointer;
        clicked => {
            root.entry-clicked(root.group-id, root.entry.installation-id, root.entry.unique-id);
        }
    }

    card-layout := VerticalLayout {
        alignment: start;
        padding: 6px;
        spacing: 3px;

        // Header row with icon and message
        HorizontalLayout {
            alignment: start;
            spacing: 4px;

            if root.entry.icon != "": Text {
                text: root.entry.icon;
                font-size: 14px;
                font-weight: 700;
                color: #333333;
            }

            Text {
                text: root.entry.msg;
                font-size: 10px;
                font-weight: 700;
                color: #333333;
                overflow: elide;
                horizontal-alignment: left;
            }
        }

        // Metadata badges row
        HorizontalLayout {
            alignment: start;
            spacing: 4px;

            if root.entry.epoch >= 0: Rectangle {
                width: epoch-label.preferred-width + 8px;
                height: epoch-label.preferred-height + 4px;
                background: #e0f0e0;
                border-radius: 3px;

                epoch-label := Text {
                    text: "E" + root.entry.epoch;
                    font-size: 8px;
                    font-weight: 600;
                    color: #448844;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            if root.entry.line-number > 0: Rectangle {
                width: line-label.preferred-width + 8px;
                height: line-label.preferred-height + 4px;
                background: #f0f0f0;
                border-radius: 3px;

                line-label := Text {
                    text: "L" + root.entry.line-number;
                    font-size: 8px;
                    font-weight: 500;
                    color: #888888;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            if root.entry.problems.length > 0: Rectangle {
                width: problem-label.preferred-width + 8px;
                height: problem-label.preferred-height + 4px;
                background: warning-touch.has-hover ? #ffe0e0 : #fff0f0;
                border-radius: 3px;

                problem-label := Text {
                    text: "⚠ " + root.entry.problems.length;
                    font-size: 8px;
                    font-weight: 600;
                    color: #cc4444;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                warning-touch := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        root.warning-clicked();
                    }
                }
            }

            if root.entry.intermediate != "": Rectangle {
                width: logs-label.preferred-width + 8px;
                height: logs-label.preferred-height + 4px;
                background: #e8f0ff;
                border-radius: 3px;

                logs-label := Text {
                    text: "Logs";
                    font-size: 8px;
                    font-weight: 600;
                    color: #4466aa;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }

        // Context entries (show first 2)
        VerticalLayout {
            alignment: start;
            spacing: 1px;

            for ctx[idx] in root.entry.context: VerticalLayout {
                visible: idx < 2;
                alignment: start;
                spacing: 0px;

                HorizontalLayout {
                    spacing: 2px;
                    Text {
                        text: ctx.key + ":";
                        font-size: 8px;
                        color: #888888;
                        font-weight: 500;
                    }

                    Text {
                        text: ctx.value;
                        font-size: 8px;
                        color: #555555;
                        overflow: elide;
                    }
                }
            }
        }
    }
}

// ─── Group Timeline Container ───

component GroupTimelineContainer inherits Rectangle {
    in property <UITimelineGroup> group;
    in property <bool> group-focused;
    in property <string> focused-intermediate;
    in property <bool> show-intermediate: root.focused-intermediate != "";

    callback focus-group(string);
    callback focus-group-logs(string, string);
    callback entry-clicked(/* group-id */ string, /* installation-id */ string, /* unique-id */ int);

    min-height: group-layout.preferred-height;
    border-width: root.group-focused ? 2px : 1px;
    border-color: root.group-focused ? root.group.group-color : #d8d8d8;
    border-radius: 8px;
    background: #fafafa;
    clip: true;

    group-layout := VerticalLayout {
        spacing: 0px;

        // ─── Group Header Bar ───
        Rectangle {
            height: 40px;
            background: #eeeeee;

            HorizontalLayout {
                padding-left: 14px;
                padding-right: 14px;
                spacing: 10px;
                alignment: start;

                // Group color dot
                Rectangle {
                    width: 14px;
                    height: 14px;
                    background: root.group.group-color;
                    border-radius: 7px;
                    y: (parent.height - self.height) / 2;
                }

                Text {
                    text: "Group: " + root.group.group-id-short;
                    font-size: 14px;
                    font-weight: 700;
                    color: #333333;
                    vertical-alignment: center;
                    overflow: elide;
                }

                Text {
                    text: root.group.total-entries + " event(s)  ·  " + root.group.installation-rows.length + " installation(s)";
                    font-size: 11px;
                    color: #777777;
                    vertical-alignment: center;
                }
            }
        }

        // ─── Timeline Content with sticky labels ───
        data-flickable := Flickable {
            min-height: 150px;
            viewport-height: self.height;

            VerticalLayout {
                alignment: start;
                spacing: 0px;

                // ─── Installation Rows ───
                for inst-row[row-idx] in root.group.installation-rows: Rectangle {
                    min-height: TimelineConstants.row-height;
                    background: mod(row-idx, 2) == 0 ? #fafafe : #f5f5fa;

                    // Row separator
                    Rectangle {
                        height: 1px;
                        background: #e8e8e8;
                        y: parent.height - 1px;
                        width: parent.width;
                    }

                    // Scrollable entry cards (with spacer for label column)
                    HorizontalLayout {
                        spacing: 0px;
                        alignment: start;
                        padding-top: TimelineConstants.row-vertical-padding;
                        padding-bottom: TimelineConstants.row-vertical-padding;

                        // Spacer for label column
                        Rectangle {
                            width: TimelineConstants.label-column-width;
                        }

                        // Entry cards positioned by slot-index
                        Rectangle {
                            width: root.group.total-slots * (TimelineConstants.entry-card-width + TimelineConstants.entry-card-gap);
                            height: TimelineConstants.row-height - 2 * TimelineConstants.row-vertical-padding;

                            for entry in inst-row.entries: TimelineEntryCard {
                                x: entry.slot-index * (TimelineConstants.entry-card-width + TimelineConstants.entry-card-gap) + TimelineConstants.entry-card-gap / 2;
                                y: 0;
                                entry: entry;
                                group-focused: root.group-focused;
                                group-id: root.group.group-id;
                                warning-clicked => {
                                    root.focus-group(root.group.group-id);
                                }
                                entry-clicked(group-id, installation-id, unique-id) => {
                                    root.entry-clicked(group-id, installation-id, unique-id);
                                }
                            }
                        }
                    }

                    // Sticky label overlay (stays fixed horizontally)
                    Rectangle {
                        x: -data-flickable.viewport-x;
                        y: 0;
                        width: TimelineConstants.label-column-width;
                        height: parent.height;
                        background: parent.background;

                        // Row separator on overlay
                        Rectangle {
                            height: 1px;
                            background: #e8e8e8;
                            y: parent.height - 1px;
                            width: parent.width;
                        }

                        InstallationLabel {
                            width: TimelineConstants.label-column-width;
                            name: inst-row.installation-name;
                            inst-color: inst-row.installation-color;
                            y: (parent.height - self.height) / 2;
                        }
                    }
                }
            }
        }

        // ─── Intermediate Logs Panel ───
        if root.show-intermediate: IntermediateLogsPanel {
            intermediate-text: root.focused-intermediate;
        }
    }
}

// ─── Timeline Tab (top-level content for the Timeline tab) ───

export component TimelineTab inherits Rectangle {
    in property <[UITimelineGroup]> timeline-groups: [];

    // Callback when an entry card is clicked
    callback entry-clicked(/* group-id */ string, /* installation-id */ string, /* unique-id */ int);

    // Focus state
    property <string> focused-group-id: "";
    property <string> focus-mode: "";
    property <string> focused-intermediate: "";
    property <bool> has-focus: root.focused-group-id != "";

    if root.timeline-groups.length == 0: Rectangle {
        background: #f5f5f5;
        border-radius: 8px;

        Text {
            text: "No timeline data available. Load a log file and build the log first.";
            color: #888888;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }

    if root.timeline-groups.length > 0: ScrollView {
        VerticalLayout {
            padding: 12px;
            spacing: 16px;
            alignment: start;

            // ─── Focus Banner ───
            if root.has-focus: FocusBanner {
                focus-mode: root.focus-mode;
                back-clicked => {
                    root.focused-group-id = "";
                    root.focus-mode = "";
                    root.focused-intermediate = "";
                }
            }

            // ─── Group Timeline Containers ───
            for group in root.timeline-groups: GroupTimelineContainer {
                property <bool> is-visible: !root.has-focus || group.group-id == root.focused-group-id;
                vertical-stretch: 0;
                visible: is-visible;
                height: is-visible ? self.preferred-height : 0;
                group: group;
                group-focused: root.has-focus && group.group-id == root.focused-group-id && root.focus-mode == "problems";
                focused-intermediate: (root.has-focus && group.group-id == root.focused-group-id && root.focus-mode == "logs") ? root.focused-intermediate : "";
                focus-group(gid) => {
                    root.focused-group-id = gid;
                    root.focus-mode = "problems";
                    root.focused-intermediate = "";
                }
                focus-group-logs(gid, intermediate) => {
                    root.focused-group-id = gid;
                    root.focus-mode = "logs";
                    root.focused-intermediate = intermediate;
                }
                entry-clicked(group-id, installation-id, unique-id) => {
                    root.focused-group-id = group-id;
                    root.focus-mode = "";
                    root.focused-intermediate = "";
                    root.entry-clicked(group-id, installation-id, unique-id);
                }
            }
        }
    }
}
