#!/usr/bin/env bash
set -eou pipefail

PACKAGE="${1:-}"
if [[ -n "${PACKAGE}" ]]; then
  PACKAGE=" -p ${PACKAGE}"
else
  PACKAGE=" --workspace --exclude xdbg --exclude xmtpv3 --exclude bindings_node --exclude mls_validation_service --exclude xmtp_cli --exclude xmtp_api_grpc"
fi

TESTS="${2:-}"

# Setup required tools
if [[ "$(uname -s)" == "Darwin" ]]; then
  LLVM="$(brew list | grep -E "^llvm$" || true)"
  if [[ -z "${LLVM}" ]]; then
    echo "Installing llvm"
    brew install llvm
    echo "Add llvm environment variables to your shell"
    exit 1
  fi
fi

WASM_BINDGEN_CLI="$(which wasm-bindgen-test-runner 2>/dev/null || true)"
if [[ -z "${WASM_BINDGEN_CLI}" ]]; then
  echo "Installing wasm-bindgen-cli"
  cargo install wasm-bindgen-cli
fi

# Skip target check in Nix environments (targets are managed by Nix)
if [[ -z "${IN_NIX_SHELL:-}" ]]; then
  WASM_TARGET="$(rustup target list --installed | grep wasm32-unknown-unknown 2>/dev/null || true)"
  if [[ -z "${WASM_TARGET}" ]]; then
    echo "Adding wasm32-unknown-unknown target"
    rustup target add wasm32-unknown-unknown
  fi
fi

export WASM_BINDGEN_TEST_ONLY_WEB=1
# export SPLIT_LINKED_MODULES=1
export NO_HEADLESS=1

cargo test --target wasm32-unknown-unknown --release \
  -p $PACKAGE --features d14n -- \
  $TESTS
