#!/usr/bin/env bash
set -eou pipefail

PACKAGE="${1:-}"
if [[ -n "${PACKAGE}" ]]; then
  PACKAGE=" -p ${PACKAGE}"
else
  PACKAGE=" --workspace --exclude xdbg --exclude xmtpv3 --exclude bindings_node --exclude mls_validation_service --exclude xmtp_cli --exclude xmtp_api_grpc --exclude xmtp_proto"
fi

TESTS="${2:-}"

export RUST_LOG=off
export WASM_BINDGEN_TEST_ONLY_WEB=1
export WASM_BINDGEN_SPLIT_LINKED_MODULES=1
export WASM_BINDGEN_TEST_TIMEOUT=180
export RSTEST_TIMEOUT=60
cargo test --locked --release --target wasm32-unknown-unknown --timings \
  $PACKAGE -- \
  $TESTS
