#!/bin/bash
set -eou pipefail
script_dir="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

"${script_dir}"/compose pull

# Build validation service image via Nix (fast path: host Docker architecture)
if [ ! -f result ] || ! tar -xOf result manifest.json 2>/dev/null | grep -q "mls-validation-service"; then
    echo "Building validation service image via Nix..."
    nix build .#validation-service-image -L
fi
docker load -i result

# Build remaining services (envoy proxy, toxiproxy, anvil)
"${script_dir}"/compose build --parallel $("${script_dir}"/compose config --services | grep -v "^validation$")

"${script_dir}"/compose up -d --remove-orphans --wait --timeout 500
