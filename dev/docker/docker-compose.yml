services:
  node:
    image: ghcr.io/xmtp/node-go:main
    profiles:
      - node-go
    platform: linux/amd64
    environment:
      - GOWAKU-NODEKEY=8a30dcb604b0b53627a5adc054dbf434b446628d4bd1eccc681d223f0550ce67
    command:
      - --store.enable
      - --store.db-connection-string=postgres://postgres:xmtp@db:5432/postgres?sslmode=disable
      - --store.reader-db-connection-string=postgres://postgres:xmtp@db:5432/postgres?sslmode=disable
      - --mls-store.db-connection-string=postgres://postgres:xmtp@mlsdb:5432/postgres?sslmode=disable
      - --mls-validation.grpc-address=validation:50051
      - --api.enable-mls
      - --api.grpc-port=5556
      - --api.http-port=5555
      - --wait-for-db=30s
      # Disable authn until we have reliable support for generating auth tokens
      # - --api.authn.enable
    ports:
      - "${NODE_GRPC_PORT}:5556"
      - "${NODE_HTTP_PORT}:5555"
    depends_on:
      - db
      - mlsdb
  node-web:
    image: ghcr.io/xmtp/grpc-web
    profiles:
      - node-go
    pull_policy: never
    platform: linux/amd64
    depends_on:
      - node
    ports:
      - 5557:5557
      - 5051:5051
      - 9901:9901
    build:
      context: ../..
      dockerfile: ./dev/docker/envoy/Dockerfile
  validation:
    image: ghcr.io/xmtp/mls-validation-service:main
    platform: linux/amd64
    profiles:
      - node-go
      - xmtpd
    environment:
      ANVIL_URL: "http://chain:8545"
    depends_on:
      - chain
  history-server:
    profiles:
      - node-go
      - xmtpd
    image: ghcr.io/xmtp/message-history-server:main
    platform: linux/amd64
    ports:
      - "${HISTORY_SERVER_PORT}:5558"
  db:
    profiles:
      - node-go
    image: postgres:13
    environment:
      POSTGRES_PASSWORD: xmtp
  mlsdb:
    profiles:
      - node-go
    image: postgres:13
    environment:
      POSTGRES_PASSWORD: xmtp
  toxiproxy:
    profiles:
      - node-go
    image: ghcr.io/shopify/toxiproxy:2.12.0
    ports:
      - 8474:8474
      - 21100-21200:21100-21200
    depends_on:
      - node
