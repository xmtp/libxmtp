#!/bin/bash
set -eou pipefail


if ! which nix &>/dev/null; then
  echo "install nix with \`./dev/nix-up\`"
  exit 0
fi

# Configure the XMTP binary cache via cachix
# cachix automatically chooses the right config approach based on trusted-user status
if ! grep -qF "xmtp.cachix.org" /etc/nix/nix.conf /etc/nix/nix.custom.conf ~/.config/nix/nix.conf 2>/dev/null; then
  echo ""
  echo "Configuring XMTP binary cache (avoids building dependencies from source)..."
  CURRENT_USER="$(whoami)"
  TRUSTED_USERS="$(nix config show trusted-users 2>/dev/null || true)"
  if echo "$TRUSTED_USERS" | grep -qwF "$CURRENT_USER"; then
    echo "User '$CURRENT_USER' is a trusted Nix user — configuring cache without sudo."
    nix run nixpkgs#cachix -- use xmtp
  else
    echo "User '$CURRENT_USER' is not a trusted Nix user — sudo required to configure cache."
    sudo nix run nixpkgs#cachix -- use xmtp
  fi
  echo "XMTP binary cache configured."
else
  echo "XMTP binary cache already configured."
fi

# Configure the Garnix binary cache
GARNIX_SUBSTITUTER="https://cache.garnix.io"
GARNIX_PUBLIC_KEY="cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g="

# Function to add value to a nix.conf setting if not already present
add_to_setting() {
  local conf_file="$1"
  local setting="$2"
  local value="$3"
  local use_sudo="$4"

  if grep -q "^${setting}" "$conf_file" 2>/dev/null; then
    # Setting exists, check if value is already there
    if ! grep "^${setting}" "$conf_file" | grep -q "$value"; then
      # Add value to existing setting
      # Use sed -i.bak for cross-platform compatibility (macOS BSD sed vs GNU sed)
      if [ "$use_sudo" = "true" ]; then
        sudo sed -i.bak "s|^\(${setting}.*\)|\1 ${value}|" "$conf_file" && sudo rm "${conf_file}.bak"
      else
        sed -i.bak "s|^\(${setting}.*\)|\1 ${value}|" "$conf_file" && rm "${conf_file}.bak"
      fi
      echo "Added $value to $setting"
    else
      echo "$value already in $setting"
    fi
  else
    # Setting doesn't exist, add it
    if [ "$use_sudo" = "true" ]; then
      echo "${setting} = ${value}" | sudo tee -a "$conf_file" > /dev/null
    else
      echo "${setting} = ${value}" >> "$conf_file"
    fi
    echo "Added $setting with $value"
  fi
}

# Check if running on NixOS
is_nixos() {
  [ -e /etc/nixos ] && [ -e /etc/NIXOS ]
}

# Create NixOS module for garnix cache (similar to cachix use)
create_nixos_garnix_module() {
  local nixos_garnix_dir="/etc/nixos/garnix"
  local garnix_nix="$nixos_garnix_dir/garnix.nix"

  # Create the garnix directory if it doesn't exist
  if [ ! -d "$nixos_garnix_dir" ]; then
    sudo mkdir -p "$nixos_garnix_dir"
  fi

  # Write the garnix.nix module
  sudo tee "$garnix_nix" > /dev/null << 'EOF'
# Generated by dev/nix-cache-up
# https://garnix.io
{
  nix.settings = {
    substituters = [
      "https://cache.garnix.io"
    ];
    trusted-public-keys = [
      "cache.garnix.io:CTFPyKSLcx5RMJKfLo5EEPUObbA78b0YQ2DTCJXqr9g="
    ];
  };
}
EOF

  echo "Created $garnix_nix"
  echo ""
  echo "To enable, add the following to your /etc/nixos/configuration.nix:"
  echo ""
  echo '  imports = ['
  echo '    ./garnix/garnix.nix'
  echo '  ];'
  echo ""
  echo "Then run: sudo nixos-rebuild switch"
}

if ! grep -qF "cache.garnix.io" /etc/nix/nix.conf /etc/nix/nix.custom.conf ~/.config/nix/nix.conf /etc/nixos/garnix/garnix.nix 2>/dev/null; then
  echo ""
  echo "Configuring Garnix binary cache..."

  if is_nixos; then
    echo "Detected NixOS — creating NixOS module."
    create_nixos_garnix_module
  else
    CURRENT_USER="$(whoami)"
    TRUSTED_USERS="$(nix config show trusted-users 2>/dev/null || true)"
    if echo "$TRUSTED_USERS" | grep -qwF "$CURRENT_USER"; then
      echo "User '$CURRENT_USER' is a trusted Nix user — configuring cache without sudo."
      NIX_CONF="${XDG_CONFIG_HOME:-$HOME/.config}/nix/nix.conf"
      mkdir -p "$(dirname "$NIX_CONF")"
      touch "$NIX_CONF"
      add_to_setting "$NIX_CONF" "extra-substituters" "$GARNIX_SUBSTITUTER" "false"
      add_to_setting "$NIX_CONF" "extra-trusted-public-keys" "$GARNIX_PUBLIC_KEY" "false"
    else
      echo "User '$CURRENT_USER' is not a trusted Nix user — sudo required to configure cache."
      NIX_CONF="/etc/nix/nix.conf"
      add_to_setting "$NIX_CONF" "extra-substituters" "$GARNIX_SUBSTITUTER" "true"
      add_to_setting "$NIX_CONF" "extra-trusted-public-keys" "$GARNIX_PUBLIC_KEY" "true"
    fi
  fi
  echo "Garnix binary cache configured."
else
  echo "Garnix binary cache already configured."
fi
