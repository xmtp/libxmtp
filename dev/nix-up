#!/bin/bash
set -eou pipefail

# Local script install & configure nix
if ! which nix &>/dev/null; then
  echo "Please review the installation script at:"
  echo "https://install.determinate.systems/nix"
  read -p "Do you want to proceed with the installation? (y/n) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --determinate
  else
    echo "Nix installation aborted."
  fi
else
  echo "detected existing nix installation"
fi




echo "direnv will automatically enter the default nix environment upon entering a configured directory"
read -p "install direnv? (y/n) " -n 1 -r
if [[ $REPLY =~ ^[Yy]$ ]]; then
  [[ "$OSTYPE" == "darwin"* ]] && brew install direnv
  [[ -f /etc/arch-release ]] && sudo pacman -S direnv
  grep -q "ubuntu" /etc/os-release 2>/dev/null && sudo apt install direnv
  echo ""
  echo "installing shell hook for bash/zsh"
  # Check if hook already exists before appending
  for shell_rc in ~/.bashrc ~/.zshrc; do
    if [[ -f "$shell_rc" ]] && ! grep -q "direnv hook" "$shell_rc"; then
      case "$shell_rc" in
        *bashrc) echo 'eval "$(direnv hook bash)"' >> "$shell_rc" ;;
        *zshrc) echo 'eval "$(direnv hook zsh)"' >> "$shell_rc" ;;
      esac
    fi
  done
else
  echo "direnv not installed"
fi
